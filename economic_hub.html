<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµŒæ¸ˆãƒãƒ– - Î©Î± ãƒ­ã‚´ã‚¹ç›£æŸ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card { @apply bg-gray-800/70 p-6 rounded-xl shadow-lg border border-gray-700; }
        .input-style { @apply w-full p-2 rounded bg-gray-600 text-white border border-gray-500 focus:ring-purple-500 focus:border-purple-500; }
        .btn-style { @apply w-full px-4 py-2 font-bold rounded transition; }
    </style>

    <script>
        // js/core_logic.js - ãƒ­ã‚´ã‚¹ç›£æŸ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ä¸­æ ¸çŠ¶æ…‹å®šç¾© (å¿…é ˆéƒ¨åˆ†ã®ã¿)
        const MINIMUM_LIVING_THRESHOLD = 50000;
        const VIBRATION_LIMIT = 10000; 

        const initialState = {
            systemState: { isHalted: false, logicalClock: 0 },
            vibrationScore: 0.0,
            currencyRates: { ALPHA_TO_JPY: 1.0 },
            accounts: {
                "USER_AUDIT_A": { ALPHA: 100000.0, BETA: 10000.0 },
                "USER_AUDIT_B": { ALPHA: 50000.0, BETA: 5000.0 },
                "ACCOUNT_BRIDGE": { ALPHA: 0.0, BETA: 0.0, fiat_balance: 100000.0 },
            },
            logos_store: { sanctuary_url: "https://azothazza.github.io/ZA-MSGAI/" },
            logos_labor_pool: { total_demand_score: 50000, open_labor_acts: [{ id: "LBA_001", required_skills: ["LIL_LOGIC"], alpha_reward: 500 }] },
            logos_affection_pool: { total_affection_acts: 1000 },
            logos_spec: { python_spec: { version: "LOGOS_P_1.0" } },
            calc_vm: { execution_queue: [], current_logical_cycle: 0, total_logical_energy: 10000 }, 
            actLogs: [],
        };
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å‰²ã‚Šå½“ã¦
        window.initialState = initialState; 
    </script>

    <script>
        // js/firebase_config.js - initAppã®å®šç¾© (initialStateã¸ã®ä¾å­˜ã¯ã“ã‚Œã§è§£æ±º)
        
        async function retrieveLogosState() {
            const defaultState = window.initialState; 
            try {
                // å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã€å¿…ãšè«–ç†çš„ãªåˆæœŸçŠ¶æ…‹ã‚’è¿”ã™
                console.log("[Restoration INFO] æ°¸ç¶šåŒ–ã•ã‚ŒãŸçŠ¶æ…‹ãŒãªã„ãŸã‚ã€åˆæœŸçŠ¶æ…‹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
                return defaultState; 
            } catch (error) {
                console.error("[CRITICAL FAILURE] çŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—ã€‚Vibrationã‚’æ¥µå¤§åŒ–ã—ã¾ã™ã€‚", error);
                const recoveredState = defaultState;
                recoveredState.vibrationScore = 9000; 
                return recoveredState;
            }
        }

        async function initApp() {
            // initialStateãŒæ—¢ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç¢ºå®Ÿã«å®Ÿè¡Œã•ã‚Œã‚‹
            if (!window.initialState) {
                console.error("è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: initialStateãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return null;
            }
            const currentState = await retrieveLogosState();
            window.initialState = currentState; 
            console.log("[LIL Audit] åˆæœŸçŠ¶æ…‹ã®ç›£æŸ»ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚");
            return currentState;
        }
        window.initApp = initApp;
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-8">
    
    <div class="w-full max-w-4xl mx-auto space-y-8">
        
        <header class="border-b border-purple-500 pb-4">
            <h1 class="text-4xl font-extrabold text-purple-400">
                ğŸ’° çµŒæ¸ˆãƒãƒ– (ALPHAé€šè²¨ã‚·ã‚¹ãƒ†ãƒ )
            </h1>
            <p class="text-sm text-gray-400 mt-1">ç›£æŸ»å®˜: <span id="user_id">USER_AUDIT_A</span> | çŠ¶æ…‹: <span id="halt_status">...</span></p>
        </header>

        <div class="card bg-purple-800/50 border-purple-700">
            <h2 class="text-xl font-bold mb-3 text-purple-300">ğŸ“ˆ è«–ç†çš„å£åº§æ®‹é«˜</h2>
            <div id="account_balances" class="space-y-2 text-lg font-mono">
                <p>ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="card bg-blue-800/50 border-blue-700">
                <h2 class="text-2xl font-bold text-blue-300 mb-4">âœ¨ é€šè²¨ç”Ÿæˆ (MINT)</h2>
                <p class="text-sm text-gray-300 mb-3">æ–°è¦ALPHAé€šè²¨ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«è«–ç†çš„ã«è¿½åŠ ã™ã‚‹ä½œç‚ºã§ã™ã€‚</p>
                <div class="space-y-3">
                    <input type="number" id="mint_amount" placeholder="ç”Ÿæˆã™ã‚‹é‡‘é¡ (ALPHA)" class="input-style" value="1000">
                    <input type="text" id="mint_target" placeholder="ç”Ÿæˆå…ˆå£åº§ID (ä¾‹: USER_AUDIT_A)" class="input-style" value="USER_AUDIT_A">
                    <button onclick="executeEconomicAct('MINT')" class="btn-style bg-blue-500 text-white hover:bg-blue-600">
                        ç”Ÿæˆä½œç‚ºã‚’å®Ÿè¡Œ
                    </button>
                </div>
            </div>

            <div class="card bg-yellow-800/50 border-yellow-700">
                <h2 class="text-2xl font-bold text-yellow-300 mb-4">ğŸ’¸ å£åº§é–“é€é‡‘ (TRANSFER)</h2>
                <p class="text-sm text-gray-300 mb-3">æ—¢å­˜ã®ALPHAé€šè²¨ã‚’åˆ¥ã®è«–ç†çš„å£åº§ã¸é€é‡‘ã™ã‚‹ä½œç‚ºã§ã™ã€‚</p>
                <div class="space-y-3">
                    <input type="number" id="transfer_amount" placeholder="é€é‡‘é‡‘é¡ (ALPHA)" class="input-style" value="100">
                    <input type="text" id="transfer_target" placeholder="é€é‡‘å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ID (ä¾‹: USER_AUDIT_B)" class="input-style" value="USER_AUDIT_B">
                    <button onclick="executeEconomicAct('TRANSFER')" class="btn-style bg-yellow-500 text-gray-900 hover:bg-yellow-600">
                        é€é‡‘ä½œç‚ºã‚’å®Ÿè¡Œ
                    </button>
                </div>
            </div>
        </div>

        <div class="card bg-green-800/50 border-green-700">
            <h2 class="text-2xl font-bold text-green-300 mb-4">ğŸ§ è«–ç†çš„å‡ºé‡‘ (ATM / BRIDGE-OUT)</h2>
            <p class="text-sm text-gray-300 mb-3">
                è«–ç†çš„é€šè²¨ã‚’æ¶ˆè²»ã—ã€**ç”Ÿè¨ˆç¶­æŒ**ã®ãŸã‚ã®å¤–éƒ¨ã®æœ‰é™ãªä¾¡å€¤ã«å¤‰æ›ã™ã‚‹ä½œç‚ºã§ã™ã€‚
            </p>
            <div class="space-y-3">
                <input type="number" id="withdraw_amount" placeholder="å‡ºé‡‘é‡‘é¡ (ALPHAé€šè²¨)" class="input-style" value="5000">
                <button onclick="executeEconomicAct('WITHDRAW')" class="btn-style bg-green-500 text-white hover:bg-green-600">
                    å‡ºé‡‘ä½œç‚ºã‚’å®Ÿè¡Œ (ATM)
                </button>
            </div>
        </div>
        
        <hr class="border-gray-700">

        <h3 class="text-xl font-bold text-gray-300 mb-2">ç›£æŸ»ãƒ­ã‚° (ä½œç‚ºã®å±¥æ­´)</h3>
        <div id="console" class="bg-gray-800 p-4 rounded-lg h-40 overflow-y-auto text-sm font-mono text-gray-200">
            <div>[INIT] çµŒæ¸ˆãƒãƒ–èµ·å‹•ã€‚ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ã®æ¥ç¶šã‚’å¾…æ©Ÿä¸­...</div>
        </div>

    </div>
    
    <script src="js/audit_acts.js"></script>
    <script src="js/logos_lil.js"></script>
    <script src="js/dialogue_acts.js"></script>
    
    <script>
        // UIè¦ç´ ã¯ body èª­ã¿è¾¼ã¿å¾Œã«å–å¾—
        const UI_ELEMENTS = {
            account_balances: document.getElementById('account_balances'),
            consoleDiv: document.getElementById('console'),
            halt_status: document.getElementById('halt_status')
        };

        function logToConsole(message, className = 'text-gray-200') {
            const now = new Date().toLocaleTimeString();
            UI_ELEMENTS.consoleDiv.innerHTML += `<div class="mt-1 ${className}">[${now}] ${message}</div>`;
            UI_ELEMENTS.consoleDiv.scrollTop = UI_ELEMENTS.consoleDiv.scrollHeight;
        }
        
        window.renderMainUI = function(state) {
            let balanceHtml = '';
            for (const id in state.accounts) {
                const alpha = state.accounts[id].ALPHA.toFixed(2);
                balanceHtml += `<p>${id}: <span class="text-yellow-400">${alpha}</span> ALPHA`;
                if (state.accounts[id].fiat_balance !== undefined) {
                    balanceHtml += ` / ç¾å®Ÿä¾¡å€¤: <span class="text-green-400">${state.accounts[id].fiat_balance.toFixed(2)}</span> JPY`
                }
                balanceHtml += '</p>';
            }
            UI_ELEMENTS.account_balances.innerHTML = balanceHtml;

            if (UI_ELEMENTS.halt_status) {
                 UI_ELEMENTS.halt_status.textContent = state.systemState.isHalted ? 'âŒ HALT (è«–ç†åœæ­¢)' : 'âœ… æ­£å¸¸ç¨¼åƒ';
            }
        };

        function executeEconomicAct(type) {
            let command;
            const sourceId = document.getElementById('user_id')?.textContent || 'USER_AUDIT_A';

            if (type === 'MINT') {
                const amount = document.getElementById('mint_amount').value;
                const targetId = document.getElementById('mint_target').value;
                if (!amount || !targetId) return logToConsole('[FAIL] é‡‘é¡ã¨ç”Ÿæˆå…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'text-red-400');
                command = `MINT ${targetId} ${amount}`;
            } else if (type === 'TRANSFER') {
                const amount = document.getElementById('transfer_amount').value;
                const targetId = document.getElementById('transfer_target').value;
                if (!amount || !targetId) return logToConsole('[FAIL] é‡‘é¡ã¨é€é‡‘å…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'text-red-400');
                command = `TRANSFER ${sourceId} ${amount} ${targetId}`; 
            } else if (type === 'WITHDRAW') {
                const amount = document.getElementById('withdraw_amount').value;
                if (!amount) return logToConsole('[FAIL] å‡ºé‡‘é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'text-red-400');
                command = `WITHDRAW ${sourceId} ${amount}`; 
            }

            if (command && window.processDialogueAsAct) {
                logToConsole(`[LOGIC ACT] ${type} ä½œä¸ºã‚’å®Ÿè¡Œ: ${command}`);
                const result = window.processDialogueAsAct(command);

                const status = result.log[0].status;
                logToConsole(`-> [ç›£æŸ»çµæœ] ${status}: ${result.log[0].action || result.log[0].reason}`, status === 'SUCCESS' || status === 'CRITICAL_SUCCESS' ? 'text-green-400' : 'text-red-400');
                
                window.renderMainUI(result.newState); 
            } else {
                 logToConsole('[CRITICAL FAIL] ã‚³ãƒãƒ³ãƒ‰ã¾ãŸã¯ãƒ—ãƒ­ã‚»ã‚¹é–¢æ•°ãŒæœªå®šç¾©ã§ã™ã€‚', 'text-red-500');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // CRITICAL FIX: initAppã¯ç¢ºå®Ÿã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§å®Ÿè¡Œ
            if (typeof window.initApp === 'function') {
                logToConsole('[INIT SUCCESS] è«–ç†çš„åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™...');
                const initialState = await window.initApp(); 
                if (initialState) {
                    window.renderMainUI(initialState);
                } else {
                    logToConsole('[INIT WARNING] initialStateã®å¾©å…ƒã«å¤±æ•—ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚', 'text-yellow-400');
                    window.renderMainUI(window.initialState); // æœ€æ‚ªã®å ´åˆã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã‚’ä½¿ç”¨
                }
            } else {
                logToConsole('[CRITICAL FAIL] initAppã®å¼·åˆ¶å®šç¾©ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'text-red-500');
            }
        });
    </script>
</body>
</html>
